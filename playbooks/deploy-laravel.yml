---
- name: Deploy Laravel Application to Kubernetes (Multi-Node Setup)
  hosts: master
  become: yes
  vars:
    k8s_manifests_dir: "../laravel-k8s"
    namespace: "laravel-app"

  tasks:
    # ============================================
    # Prerequisite: Install Storage Provisioner
    # ============================================
    - name: Check if local-path-provisioner namespace exists
      ansible.builtin.command:
        cmd: kubectl get ns local-path-storage
      register: lps_ns
      failed_when: false
      changed_when: false

    - name: Install local-path-provisioner if missing
      ansible.builtin.command:
        cmd: kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml
      when: lps_ns.rc != 0
      register: provisioner_result
      changed_when: "'created' in provisioner_result.stdout or 'configured' in provisioner_result.stdout"
      failed_when: provisioner_result.rc != 0 and provisioner_result.rc is not none

    - name: Wait for local-path-provisioner to be ready (if just installed)
      ansible.builtin.command:
        cmd: kubectl wait --for=condition=ready pod -l app=local-path-provisioner -n local-path-storage --timeout=60s
      register: provisioner_wait
      retries: 3
      delay: 5
      until: provisioner_wait.rc == 0
      ignore_errors: yes
      when: lps_ns.rc != 0

    - name: Check if StorageClass local-path exists
      ansible.builtin.command:
        cmd: kubectl get sc local-path -o json
      register: sc_json
      failed_when: false
      changed_when: false

    - name: Set StorageClass facts
      ansible.builtin.set_fact:
        sc_exists: "{{ sc_json.rc == 0 }}"
        sc_volume_binding_mode: "{{ (sc_json.stdout | from_json).volumeBindingMode if sc_json.rc == 0 and (sc_json.stdout | from_json).volumeBindingMode is defined else '' }}"
      changed_when: false

    - name: Create StorageClass manifest only if missing
      ansible.builtin.copy:
        dest: /root/sc-localpath.yaml
        content: |
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: local-path
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: rancher.io/local-path
          reclaimPolicy: Delete
          volumeBindingMode: WaitForFirstConsumer
      when: not sc_exists
      register: sc_manifest_file

    - name: Apply StorageClass if created
      ansible.builtin.command:
        cmd: kubectl apply -f /root/sc-localpath.yaml
      when: not sc_exists
      register: sc_apply
      changed_when: "'created' in sc_apply.stdout or 'configured' in sc_apply.stdout"
      failed_when: sc_apply.rc != 0 and sc_apply.rc is not none

    - name: Confirm StorageClass is present
      ansible.builtin.command:
        cmd: kubectl get storageclass local-path
      changed_when: false

    # ============================================
    # Verify Cluster Nodes (Multi-Node Check)
    # ============================================
    - name: Get cluster nodes
      ansible.builtin.command:
        cmd: kubectl get nodes
      register: cluster_nodes
      changed_when: false

    - name: Display cluster topology
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: Count worker nodes
      ansible.builtin.shell:
        cmd: kubectl get nodes --no-headers | grep -v 'control-plane' | wc -l
      register: worker_count
      changed_when: false

    - name: Set cluster mode
      ansible.builtin.set_fact:
        is_multinode: "{{ worker_count.stdout | int > 0 }}"
        total_workers: "{{ worker_count.stdout | int }}"

    - name: Display cluster mode
      ansible.builtin.debug:
        msg:
          - "Cluster Mode: {{ 'Multi-Node' if is_multinode else 'Single-Node' }}"
          - "Worker Nodes: {{ total_workers }}"

    # ============================================
    # Copy Manifests to Master Node
    # ============================================
    - name: Create directory for Kubernetes manifests
      ansible.builtin.file:
        path: "/root/laravel-k8s"
        state: directory
        mode: "0755"

    - name: Copy Kubernetes manifests to master node
      ansible.builtin.copy:
        src: "{{ k8s_manifests_dir }}/"
        dest: "/root/laravel-k8s/"
        mode: "0644"

    # ============================================
    # Step 1: Create Namespace
    # ============================================
    - name: Apply namespace
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/1-namespace.yaml
      register: namespace_result
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"

    - name: Wait for namespace to be active
      ansible.builtin.command:
        cmd: kubectl get namespace {{ namespace }}
      register: ns_check
      retries: 5
      delay: 2
      until: ns_check.rc == 0
      changed_when: false

    # ============================================
    # Step 2: Apply Secrets
    # ============================================
    - name: Apply Laravel secrets
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/2-secrets.yaml
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout"

    # ============================================
    # Step 3: Apply ConfigMaps
    # ============================================
    - name: Apply ConfigMaps (Laravel + Nginx)
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/3-configmaps.yaml
      register: configmap_result
      changed_when: "'created' in configmap_result.stdout or 'configured' in configmap_result.stdout"

    # ============================================
    # Step 4: Deploy MySQL
    # ============================================
    - name: Apply MySQL resources (PVC + StatefulSet + Service)
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/4-mysql.yaml
      register: mysql_result
      changed_when: "'created' in mysql_result.stdout or 'configured' in mysql_result.stdout"

    - name: Wait for MySQL PVC to be bound
      ansible.builtin.command:
        cmd: kubectl get pvc mysql-pvc -n {{ namespace }} -o jsonpath='{.status.phase}'
      register: pvc_status
      retries: 20
      delay: 10
      until: pvc_status.stdout == "Bound"
      changed_when: false

    - name: Check which node MySQL is scheduled on
      ansible.builtin.shell:
        cmd: kubectl get pods -l app=mysql -n {{ namespace }} -o jsonpath='{.items[0].spec.nodeName}'
      register: mysql_node
      changed_when: false
      ignore_errors: yes

    - name: Display MySQL node placement
      ansible.builtin.debug:
        msg: "MySQL pod scheduled on node: {{ mysql_node.stdout | default('Not yet scheduled') }}"

    - name: Wait for MySQL pod to be ready
      ansible.builtin.command:
        cmd: kubectl wait --for=condition=ready pod -l app=mysql -n {{ namespace }} --timeout=180s
      register: mysql_wait
      retries: 3
      delay: 10
      until: mysql_wait.rc == 0

    - name: Verify MySQL is running
      ansible.builtin.command:
        cmd: kubectl get pods -l app=mysql -n {{ namespace }} -o wide
      register: mysql_pods
      changed_when: false

    - name: Show MySQL pod status with node info
      ansible.builtin.debug:
        msg: "{{ mysql_pods.stdout_lines }}"

    # ============================================
    # Step 5: Deploy Laravel with Sidecar Pattern
    # ============================================
    - name: Apply Laravel deployment with sidecar pattern
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/5-laravel-sidecar.yaml
      register: laravel_result
      changed_when: "'created' in laravel_result.stdout or 'configured' in laravel_result.stdout"

    - name: Wait for Laravel pods to be ready
      ansible.builtin.command:
        cmd: kubectl wait --for=condition=ready pod -l app=laravel -n {{ namespace }} --timeout=180s
      register: laravel_wait
      retries: 3
      delay: 10
      until: laravel_wait.rc == 0

    - name: Check Laravel pod distribution across nodes
      ansible.builtin.shell:
        cmd: kubectl get pods -l app=laravel -n {{ namespace }} -o custom-columns=NAME:.metadata.name,NODE:.spec.nodeName --no-headers
      register: laravel_distribution
      changed_when: false

    - name: Display Laravel pod distribution
      ansible.builtin.debug:
        msg: "{{ laravel_distribution.stdout_lines }}"

    - name: Verify Laravel pods are running (2 containers each)
      ansible.builtin.command:
        cmd: kubectl get pods -l app=laravel -n {{ namespace }} -o wide
      register: laravel_pods
      changed_when: false

    - name: Show Laravel pod status with node info
      ansible.builtin.debug:
        msg: "{{ laravel_pods.stdout_lines }}"

    # ============================================
    # Step 6: Create Service
    # ============================================
    - name: Apply Laravel service
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/6-service.yaml
      register: service_result
      changed_when: "'created' in service_result.stdout or 'configured' in service_result.stdout"

    - name: Wait for service to be available
      ansible.builtin.command:
        cmd: kubectl get svc laravel-service -n {{ namespace }}
      register: service_check
      retries: 5
      delay: 2
      until: service_check.rc == 0
      changed_when: false

    # ============================================
    # Step 7: Configure Autoscaling (HPA)
    # ============================================
    - name: Apply Horizontal Pod Autoscaler
      ansible.builtin.command:
        cmd: kubectl apply -f /root/laravel-k8s/7-hpa.yaml
      register: hpa_result
      changed_when: "'created' in hpa_result.stdout or 'configured' in hpa_result.stdout"

    - name: Wait for HPA to initialize
      ansible.builtin.command:
        cmd: kubectl get hpa laravel-hpa -n {{ namespace }}
      register: hpa_check
      retries: 5
      delay: 2
      until: hpa_check.rc == 0
      changed_when: false

    - name: Display HPA status
      ansible.builtin.command:
        cmd: kubectl get hpa laravel-hpa -n {{ namespace }}
      register: hpa_status
      changed_when: false

    - name: Show HPA details
      ansible.builtin.debug:
        msg: "{{ hpa_status.stdout_lines }}"

    # ============================================
    # Post-Deployment: Verification
    # ============================================
    - name: Get all resources in namespace
      ansible.builtin.command:
        cmd: kubectl get all -n {{ namespace }} -o wide
      register: all_resources
      changed_when: false

    - name: Display all resources with node info
      ansible.builtin.debug:
        msg: "{{ all_resources.stdout_lines }}"

    - name: Get service details
      ansible.builtin.command:
        cmd: kubectl get svc laravel-service -n {{ namespace }} -o wide
      register: service_details
      changed_when: false

    - name: Display service access information
      ansible.builtin.debug:
        msg: "{{ service_details.stdout_lines }}"

    - name: Check Laravel container logs (Nginx)
      ansible.builtin.shell:
        cmd: kubectl logs -l app=laravel -c nginx -n {{ namespace }} --tail=20
      register: nginx_logs
      changed_when: false
      ignore_errors: yes

    - name: Display Nginx logs
      ansible.builtin.debug:
        msg: "{{ nginx_logs.stdout_lines }}"
      when: nginx_logs.rc == 0

    - name: Check Laravel container logs (PHP-FPM)
      ansible.builtin.shell:
        cmd: kubectl logs -l app=laravel -c php-fpm -n {{ namespace }} --tail=20
      register: php_logs
      changed_when: false
      ignore_errors: yes
 
    - name: Display PHP-FPM logs
      ansible.builtin.debug:
        msg: "{{ php_logs.stdout_lines }}"
      when: php_logs.rc == 0

    - name: Get node IPs for external access
      ansible.builtin.shell:
        cmd: kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}'
      register: node_ips
      changed_when: false

    - name: Display access URL
      ansible.builtin.debug:
        msg:
          - "=================================="
          - "Laravel Application Deployed!"
          - "=================================="
          - "Cluster Mode: {{ 'Multi-Node (' + total_workers|string + ' workers)' if is_multinode else 'Single-Node' }}"
          - "Access URLs (any node):"
          - "{% for ip in node_ips.stdout.split() %}  - http://{{ ip }}:30080{% endfor %}"
          - "Namespace: {{ namespace }}"
          - ""
          - "Resources:"
          - "  - MySQL: mysql-0 (StatefulSet) on node {{ mysql_node.stdout | default('N/A') }}"
          - "  - Laravel: 2+ pods with Nginx + PHP-FPM (distributed across nodes)"
          - "  - Service: laravel-service (NodePort:30080)"
          - "  - HPA: Min 2, Max 10 replicas"
          - ""
          - "Pod Distribution:"
          - "{{ laravel_distribution.stdout }}"
          - ""
          - "Useful Commands:"
          - "  kubectl get pods -n {{ namespace }} -o wide"
          - "  kubectl logs -f deployment/laravel -c nginx -n {{ namespace }}"
          - "  kubectl logs -f deployment/laravel -c php-fpm -n {{ namespace }}"
          - "  kubectl exec -it deployment/laravel -c php-fpm -n {{ namespace }} -- bash"
          - "  kubectl top pods -n {{ namespace }}"
          - "  kubectl get hpa -n {{ namespace }} --watch"
          - "=================================="

    # ============================================
    #  Run Laravel Migrations
    # ============================================
    - name: Run Laravel migrations
      ansible.builtin.shell:
        cmd: |
          POD=$(kubectl get pods -l app=laravel -n {{ namespace }} -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n {{ namespace }} $POD -c php-fpm -- php artisan migrate --force
      register: migration_result
      changed_when: "'Migrating' in migration_result.stdout"
      failed_when: false
      ignore_errors: yes

    - name: Display migration result
      ansible.builtin.debug:
        msg: "{{ migration_result.stdout_lines }}"
      when: migration_result.rc == 0

    # ============================================
    # Final Status Summary
    # ============================================
    - name: Final deployment summary
      ansible.builtin.debug:
        msg:
          - "=================================="
          - "Deployment Summary"
          - "=================================="
          - "Cluster: {{ 'Multi-Node' if is_multinode else 'Single-Node' }}"
          - "Worker Nodes: {{ total_workers }}"
          - ""
          - "Status:"
          - "  ✓ Namespace: {{ namespace }}"
          - "  ✓ MySQL: {{ 'Running on ' + mysql_node.stdout if mysql_wait.rc == 0 else 'Failed' }}"
          - "  ✓ Laravel: {{ 'Running' if laravel_wait.rc == 0 else 'Failed' }}"
          - "  ✓ Service: {{ 'Available' if service_check.rc == 0 else 'Failed' }}"
          - "  ✓ HPA: {{ 'Configured' if hpa_check.rc == 0 else 'Failed' }}"
          - "  ✓ Storage: local-path (WaitForFirstConsumer)"
          - ""
          - "Load Distribution:"
          - "  - Laravel pods distributed across available nodes"
          - "  - MySQL pinned to one node (StatefulSet)"
          - "  - Service accessible from any node IP"
          - ""
          - "Next Steps:"
          - "  1. Test: curl http://{{ node_ips.stdout.split()[0] }}:30080"
          - "  2. Monitor: kubectl get hpa -n {{ namespace }} --watch"
          - "  3. Scale test: Generate load to trigger HPA"
          - "=================================="